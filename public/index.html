<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒã‚±ãƒ¦ãƒŠ é¸æ‰‹ç™»éŒ² & 9ãƒãƒ¼ãƒ ãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆé€æ¬¡ / d100ï¼‰</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--sub:#1f2937;--text:#e5e7eb;--muted:#9ca3af;--acc:#22d3ee;--good:#34d399;--bad:#f87171;--warn:#f59e0b}
    html,body{margin:0;padding:0;background:linear-gradient(180deg,#0b1220,#0f172a 40%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px 80px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{background:var(--sub);border:1px solid #374151;border-bottom:none;border-top-left-radius:10px;border-top-right-radius:10px;padding:10px 14px;cursor:pointer;color:var(--muted)}
    .tab.active{background:var(--card);color:var(--text)}
    .panel{background:var(--card);border:1px solid #374151;border-radius:12px;padding:18px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:1000px){.g2,.g3{grid-template-columns:1fr}}
    input[type=text],input[type=password],select,textarea{width:100%;padding:10px;border-radius:10px;background:#0b1220;border:1px solid #233047;color:var(--text)}
    textarea{min-height:72px;resize:vertical}
    .btn{display:inline-flex;align-items:center;gap:8px;border-radius:12px;padding:10px 14px;border:1px solid #324256;background:#152238;color:var(--text);cursor:pointer}
    .btn.acc{background:linear-gradient(180deg,#1cc9ff,#22d3ee);color:#03121a;border:none}
    .btn.bad{background:#361e1e;border-color:#7a1f1f}
    .btn.warn{background:#3a2a12;border-color:#7a5d1f}
    .card{background:linear-gradient(180deg,#0e1627,#0a1220);border:1px solid #293042;border-radius:12px;padding:12px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .avatar{width:72px;height:72px;border-radius:10px;object-fit:cover;border:1px solid #263244;background:#0b1220}
    .pokeThumb{width:68px;height:68px;border-radius:10px;object-fit:contain;border:1px dashed #2a3a56;background:#0b1220}
    .tag{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #2a3a56;color:#9bd5ff}
    .pill{border-radius:999px;padding:4px 10px;border:1px solid #304057;background:#0d1626;color:#a8d6ff;font-size:12px}
    .pill.lock{color:#fef3c7;border-color:#7a5d1f;background:#3a2a12}
    .pill.ok{color:#d1fae5;border-color:#065f46;background:#064e3b}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .hidden{display:none}
    .hr{height:1px;background:#22314a;margin:12px 0;border:0}
    .note{font-size:12px;color:#cbd5e1}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #2a344a;padding:8px 6px;text-align:left}
    .center{text-align:center}
    .right{text-align:right}
    .teamGrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media (max-width:1200px){.teamGrid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:800px){.teamGrid{grid-template-columns:1fr}}
    .locksBar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸŸ£ ãƒã‚±ãƒ¦ãƒŠé¸æ‰‹ç™»éŒ² & 9ãƒãƒ¼ãƒ ãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆé€æ¬¡ / d100ï¼‰</h1>
  <div class="note">URLæœ«å°¾ã« <code>?room=ä»»æ„</code> ã§ãƒ«ãƒ¼ãƒ åˆ†ã‘ã€‚ç”»åƒã¯ <code>/images/</code> é…ä¸‹ã‹ã‚‰é¸æŠã€‚</div>

  <div class="tabs" id="tabs">
    <button class="tab active" data-panel="register">â‘  é¸æ‰‹ç™»éŒ²</button>
    <button class="tab" data-panel="players">ç™»éŒ²ä¸€è¦§</button>
    <button class="tab" data-panel="draft">â‘¡ ãƒ‰ãƒ©ãƒ•ãƒˆ</button>
    <button class="tab" data-panel="backup">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
  </div>

  <!-- Register Panel -->
  <section class="panel" id="panel-register">
    <form id="playerForm" class="grid g2">
      <div>
        <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
        <input type="text" id="pName" required placeholder="ä¾‹ï¼šãƒ¦ã‚¦ãƒ¤" />
      </div>
      <div>
        <label>ãƒ©ãƒ³ã‚¯</label>
        <select id="pRank" required>
          <option value="ãƒ“ã‚®ãƒŠãƒ¼">ãƒ“ã‚®ãƒŠãƒ¼</option>
          <option value="ã‚¹ãƒ¼ãƒ‘ãƒ¼">ã‚¹ãƒ¼ãƒ‘ãƒ¼</option>
          <option value="ãƒã‚¤ãƒ‘ãƒ¼">ãƒã‚¤ãƒ‘ãƒ¼</option>
          <option value="ã‚¨ãƒªãƒ¼ãƒˆ">ã‚¨ãƒªãƒ¼ãƒˆ</option>
          <option value="ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ">ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ</option>
          <option value="ãƒã‚¹ã‚¿ãƒ¼1200">ãƒã‚¹ã‚¿ãƒ¼1200</option>
          <option value="ãƒã‚¹ã‚¿ãƒ¼1400ï½1600">ãƒã‚¹ã‚¿ãƒ¼1400ï½1600</option>
        </select>
        <div class="note">ãƒã‚¤ãƒ³ãƒˆï¼ˆè‡ªå‹•ï¼‰ï¼š<span id="autoPoint" class="pill">-</span></div>
      </div>
      <div>
        <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”»åƒï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰</label>
        <input type="file" id="pAvatar" accept="image/*">
        <div class="row" style="margin-top:8px"><img id="avatarPreview" class="avatar" alt="preview"></div>
      </div>
      <div>
        <label>æ„æ°—è¾¼ã¿</label>
        <textarea id="pComment" placeholder="ä¾‹ï¼šçµ¶å¯¾å‹ã¡ã¾ã™ï¼é€£æºé‡è¦–ã§è¡Œãã¾ã™"></textarea>
      </div>

      <div class="g3">
        <div>
          <label>ä½¿ç”¨ãƒã‚±ãƒ¢ãƒ³â‘ ï¼ˆ/images/ ã‹ã‚‰é¸æŠï¼‰</label>
          <select class="pokeSelect" data-slot="0"></select>
          <div class="row" style="margin-top:6px"><img class="pokeThumb" id="pokePrev0" alt="poke1"></div>
        </div>
        <div>
          <label>ä½¿ç”¨ãƒã‚±ãƒ¢ãƒ³â‘¡ï¼ˆ/images/ ã‹ã‚‰é¸æŠï¼‰</label>
          <select class="pokeSelect" data-slot="1"></select>
          <div class="row" style="margin-top:6px"><img class="pokeThumb" id="pokePrev1" alt="poke2"></div>
        </div>
        <div>
          <label>ä½¿ç”¨ãƒã‚±ãƒ¢ãƒ³â‘¢ï¼ˆ/images/ ã‹ã‚‰é¸æŠï¼‰</label>
          <select class="pokeSelect" data-slot="2"></select>
          <div class="row" style="margin-top:6px"><img class="pokeThumb" id="pokePrev2" alt="poke3"></div>
        </div>
      </div>

      <input type="hidden" id="editId" value="">
      <div class="row">
        <button type="submit" class="btn acc" id="btnRegister">ç™»éŒ²ã™ã‚‹ / ä¸Šæ›¸ãä¿å­˜</button>
        <button type="button" id="resetForm" class="btn">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div class="note">â€» ç™»éŒ²ãƒ»ç·¨é›†æ™‚ã«æ“ä½œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</div>
    </form>
  </section>

  <!-- Players Panel -->
  <section class="panel hidden" id="panel-players">
    <div class="row" style="justify-content:space-between">
      <div class="note">ç™»éŒ²äººæ•°ï¼š<span id="playerCount">0</span></div>
      <div class="row">
        <button id="sortHigh" class="btn">ãƒã‚¤ãƒ³ãƒˆé«˜ã„é †</button>
        <button id="sortLow" class="btn">ãƒã‚¤ãƒ³ãƒˆä½ã„é †</button>
        <button id="clearAll" class="btn bad">å…¨å‰Šé™¤</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="playerList" class="list"></div>
    <div class="note" style="margin-top:8px">â€» å…¨å‰Šé™¤ãƒ»å€‹åˆ¥å‰Šé™¤ãƒ»ç·¨é›†ã¯æ“ä½œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</div>
  </section>

  <!-- Draft Panel -->
  <section class="panel hidden" id="panel-draft">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="locksBar" id="locksBar"></div>
      <div class="row">
        <span class="pill">Cycle: <span id="cycleLab">-</span></span>
        <span class="pill">Round: <span id="roundLab">-</span></span>
        <span class="pill">Max Team: <span id="maxTeamLab">-</span></span>
        <span class="pill" id="requireLocksLab">Locks Required: -</span>
      </div>
    </div>

    <div class="teamGrid" id="loginGrid"></div>

    <div class="hr"></div>
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="row">
        <button class="btn acc" id="startDraft">ãƒ‰ãƒ©ãƒ•ãƒˆé–‹å§‹</button>
        <button class="btn warn" id="nextStep" disabled>æ¬¡</button>
        <button class="btn" id="resetDraft">ãƒ‰ãƒ©ãƒ•ãƒˆåˆæœŸåŒ–</button>
      </div>
      <div class="note" id="progressNote">â€» ãƒ­ãƒƒã‚¯ã¯ä»»æ„ã€‚æœªãƒ­ãƒƒã‚¯ãŒã„ã¦ã‚‚ã€Œæ¬¡ã€ã§å…¬é–‹ï¼†d100è§£æ±ºã—ã¾ã™ã€‚</div>
    </div>

    <div class="teamGrid" id="teamsGrid"></div>

    <div class="card" style="margin-top:12px">
      <h3>ãƒ­ã‚°</h3>
      <div id="log" class="note"></div>
    </div>
  </section>

  <!-- Backup Panel -->
  <section class="panel hidden" id="panel-backup">
    <div class="grid g2">
      <div>
        <h3>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
        <button class="btn" id="exportBtn">JSONã‚’æ›¸ãå‡ºã™</button>
        <div class="note">â€» æ›¸ãå‡ºã—æ™‚ã«æ“ä½œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</div>
      </div>
      <div>
        <h3>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
        <input type="file" id="importFile" accept="application/json">
      </div>
    </div>
  </section>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
// ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
const POINTS_BY_RANK = { 'ãƒ“ã‚®ãƒŠãƒ¼':5,'ã‚¹ãƒ¼ãƒ‘ãƒ¼':5,'ãƒã‚¤ãƒ‘ãƒ¼':10,'ã‚¨ãƒªãƒ¼ãƒˆ':10,'ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ':15,'ãƒã‚¹ã‚¿ãƒ¼1200':15,'ãƒã‚¹ã‚¿ãƒ¼1400ï½1600':20 };
function escapeHTML(s){ return (s||'').replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
async function fileToDataURL(file){ return await new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }
function badge(txt, cls='pill'){ return `<span class="${cls}">${txt}</span>`; }

// ====== æ¥ç¶š ======
const roomId = new URL(location.href).searchParams.get('room') || 'default';
const socket = io('/', { auth: { room: roomId } });

let MAX_ROUNDS = 5; let MAX_TEAM = 5; let TEAM_IDS = ['A','B']; let REQUIRE_LOCKS = false;
let players = []; let draft = { locks:{}, picks:{}, teams:{}, state:{mode:'idle',cycle:1,round:0} };
let imageFiles = [];
let currentSort = null;

socket.on('state:init', ({ state, maxRounds, teams, maxTeam, requireLocks })=>{
  MAX_ROUNDS = maxRounds; TEAM_IDS = teams; MAX_TEAM = maxTeam; REQUIRE_LOCKS = !!requireLocks;
  document.getElementById('maxTeamLab').textContent = String(MAX_TEAM);
  document.getElementById('requireLocksLab').textContent = `Locks Required: ${REQUIRE_LOCKS?'Yes':'No'}`;
  document.getElementById('progressNote').textContent = REQUIRE_LOCKS
    ? 'â€» å…¨ãƒãƒ¼ãƒ ãƒ­ãƒƒã‚¯å¾Œã«ã€Œæ¬¡ã€ã§å…¬é–‹ï¼†d100è§£æ±ºã—ã¾ã™ã€‚'
    : 'â€» ãƒ­ãƒƒã‚¯ã¯ä»»æ„ã€‚æœªãƒ­ãƒƒã‚¯ãŒã„ã¦ã‚‚ã€Œæ¬¡ã€ã§å…¬é–‹ï¼†d100è§£æ±ºã—ã¾ã™ã€‚';

  players = state.players; draft = state.draft;
  renderAll(); buildLoginCards(); buildTeamPanels(); fetchImages();
  updateStateBar();
});
socket.on('players:updated', (list)=>{ players=list; renderPlayers(); refreshPickers(); renderTeams(); });
socket.on('draft:picksUpdated', (picks)=>{ draft.picks=picks; refreshPickers(); });
socket.on('draft:locksUpdated', (locks)=>{ draft.locks=locks; refreshPickers(); renderLocksBar(); });
socket.on('draft:resolved', ({draft: d, logs})=>{ draft=d; logs.forEach(appendLog); refreshPickers(); renderTeams(); renderLocksBar(); updateStateBar(); });
socket.on('draft:state', (st)=>{ draft.state = st; updateStateBar(); updateNextButton(); });
socket.on('state:updated', (state)=>{ players=state.players; draft=state.draft; renderAll(); buildLoginCards(); buildTeamPanels(); updateStateBar(); renderLocksBar(); });
socket.on('action:err', ({message})=> alert(message));
socket.on('leader:ok', ({role})=>{ const area=document.getElementById('area'+role); if(area) area.classList.remove('hidden'); });
socket.on('leader:err', ({message})=> alert(message));
socket.on('player:updated:ok', ()=>{ alert('ç·¨é›†ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); resetEditFormLabel(); });

// ====== ã‚¿ãƒ– ======
const tabs = document.querySelectorAll('.tab');
const panels = { register:panel('register'), players:panel('players'), draft:panel('draft'), backup:panel('backup') };
function panel(id){ return document.getElementById('panel-'+id); }
for(const t of tabs){
  t.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    Object.values(panels).forEach(p=>p.classList.add('hidden'));
    panels[t.dataset.panel].classList.remove('hidden');
    if(t.dataset.panel==='players') renderPlayers();
    if(t.dataset.panel==='draft'){ refreshPickers(); renderTeams(); renderLocksBar(); updateStateBar(); updateNextButton(); }
  });
}

// ====== ãƒ©ãƒ³ã‚¯â†’ãƒã‚¤ãƒ³ãƒˆ ======
const rankEl = document.getElementById('pRank');
const pointLabel = document.getElementById('autoPoint');
function updatePoint(){ pointLabel.textContent = POINTS_BY_RANK[rankEl.value] ?? '-' } updatePoint();
rankEl.addEventListener('change', updatePoint);

// ====== ç”»åƒä¸€è¦§ï¼ˆ/imagesï¼‰â†’ ä½¿ç”¨ãƒã‚±ãƒ¢ãƒ³é¸æŠ ======
const pokeSelects = [...document.querySelectorAll('.pokeSelect')];
const pokePreviews = [0,1,2].map(i=>document.getElementById('pokePrev'+i));
async function fetchImages(){
  const r = await fetch('/api/images',{cache:'no-store'}).then(r=>r.json()).catch(()=>({files:[]}));
  imageFiles = r.files||[];
  for(const sel of pokeSelects){
    sel.innerHTML = '<option value="">ï¼ˆé¸æŠã—ãªã„ï¼‰</option>' + imageFiles.map(f=>`<option value="/images/${f}">${f}</option>`).join('');
    sel.addEventListener('change', (e)=>{ const slot=Number(e.target.dataset.slot); const val=e.target.value; pokePreviews[slot].src = val || ''; });
  }
}

// ====== ç™»éŒ²/ç·¨é›† ======
const form = document.getElementById('playerForm');
const avatarInput = document.getElementById('pAvatar');
const avatarPreview = document.getElementById('avatarPreview');
avatarInput.addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; avatarPreview.src = f? await fileToDataURL(f): '' });

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const actionPass = prompt('æ“ä½œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); if(!actionPass) return;

  const name = document.getElementById('pName').value.trim(); if(!name) return alert('åå‰');
  const rank = rankEl.value; const comment = document.getElementById('pComment').value.trim();
  const avatar = avatarPreview.src || '';
  const pokes = [0,1,2].map(i=>pokePreviews[i].src||'').filter(Boolean);
  if(pokes.length<3 && !confirm('ãƒã‚±ãƒ¢ãƒ³ãŒ3æšæœªæº€ã§ã™ã€‚ã“ã®ã¾ã¾ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;

  const editingId = document.getElementById('editId').value.trim();
  const payload = { actionPass, name, rank, avatar, pokes: pokes.slice(0,3), comment };
  if(editingId){ socket.emit('player:update', { id: editingId, ...payload }); }
  else{ socket.emit('player:add', payload); }

  form.reset(); avatarPreview.src=''; pokePreviews.forEach(img=>img.src=''); updatePoint(); resetEditFormLabel();
});
function resetEditFormLabel(){
  document.getElementById('editId').value='';
  document.getElementById('btnRegister').textContent='ç™»éŒ²ã™ã‚‹ / ä¸Šæ›¸ãä¿å­˜';
}
document.getElementById('resetForm').addEventListener('click', ()=>{ form.reset(); avatarPreview.src=''; pokePreviews.forEach(img=>img.src=''); updatePoint(); resetEditFormLabel(); });

// ====== ä¸€è¦§ãƒ»ä¸¦ã³æ›¿ãˆãƒ»å€‹åˆ¥å‰Šé™¤ãƒ»ç·¨é›†èµ·å‹• ======
const playerListEl = document.getElementById('playerList');
const playerCountEl = document.getElementById('playerCount');

document.getElementById('sortHigh').addEventListener('click', ()=>{ currentSort='high'; renderPlayers(); });
document.getElementById('sortLow').addEventListener('click', ()=>{ currentSort='low'; renderPlayers(); });

document.getElementById('clearAll').addEventListener('click', ()=>{
  const actionPass = prompt('æ“ä½œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå…¨å‰Šé™¤ï¼‰'); if(!actionPass) return;
  if(confirm('æœ¬å½“ã«å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) socket.emit('players:clearAll', { actionPass });
});

playerListEl.addEventListener('click', (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id; const act = btn.dataset.act;

  if(act==='del'){
    const actionPass = prompt('æ“ä½œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå‰Šé™¤ï¼‰'); if(!actionPass) return;
    if(confirm('ã“ã®é¸æ‰‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) socket.emit('player:delOne', { id, actionPass });

  }else if(act==='edit'){
    const actionPass = prompt('æ“ä½œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç·¨é›†ã‚’é–‹å§‹ï¼‰'); if(!actionPass) return;
    const p = players.find(x=>x.id===id); if(!p) return;
    document.querySelector('[data-panel="register"]').click();
    document.getElementById('pName').value = p.name;
    document.getElementById('pRank').value = p.rank; updatePoint();
    document.getElementById('pComment').value = p.comment || '';
    document.getElementById('editId').value = p.id;
    document.getElementById('btnRegister').textContent = 'ç·¨é›†ã‚’ä¿å­˜';
    avatarPreview.src = p.avatar || '';
    p.pokes?.forEach((src,i)=>{ if(pokePreviews[i]) pokePreviews[i].src = src; });
    pokeSelects.forEach((sel,idx)=>{ const src=p.pokes?.[idx]||''; const val = imageFiles.find(f=>(`/images/${f}`)===src) ? src : ''; sel.value = val; });
  }
});

function renderPlayers(){
  playerCountEl.textContent = players.length;
  let list = players.slice();
  if(currentSort==='high') list.sort((a,b)=> (b.points||0)-(a.points||0));
  if(currentSort==='low')  list.sort((a,b)=> (a.points||0)-(b.points||0));

  playerListEl.innerHTML = list.map(p=>`
    <div class="card">
      <div class="row">
        <img class="avatar" src="${p.avatar||''}" alt="avatar" onerror="this.style.display='none'">
        <div style="min-width:0">
          <div style="font-weight:600">${escapeHTML(p.name)} <span class="tag">${escapeHTML(p.rank)} / ${p.points}pt</span></div>
          <div class="note" style="white-space:pre-wrap;margin-top:4px">${escapeHTML(p.comment||'')}</div>
          <div class="row" style="margin-top:6px">${(p.pokes||[]).map(src=>`<img class='pokeThumb' src='${src}' alt='poke'>`).join('')}</div>
          <div class="row" style="margin-top:8px">
            <button class="btn"      data-act="edit" data-id="${p.id}">ç·¨é›†</button>
            <button class="btn bad"  data-act="del"  data-id="${p.id}">å‰Šé™¤</button>
          </div>
        </div>
      </div>
    </div>`).join('');
}

// ====== ãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆæœ€å¤§9ãƒãƒ¼ãƒ  / é€æ¬¡ï¼‰ ======
const loginGrid = document.getElementById('loginGrid');
const teamsGrid = document.getElementById('teamsGrid');
const logEl = document.getElementById('log');
const locksBar = document.getElementById('locksBar');
const cycleLab = document.getElementById('cycleLab');
const roundLab = document.getElementById('roundLab');
const maxTeamLab = document.getElementById('maxTeamLab');
const requireLocksLab = document.getElementById('requireLocksLab');
const startDraftBtn = document.getElementById('startDraft');
const nextBtn = document.getElementById('nextStep');

function buildLoginCards(){
  loginGrid.innerHTML = TEAM_IDS.map(t=>`
    <div class="card">
      <h3>ãƒªãƒ¼ãƒ€ãƒ¼${t} ãƒ­ã‚°ã‚¤ãƒ³ ${badge('æœªãƒ­ãƒƒã‚¯','pill lock')}</h3>
      <div class="row">
        <input type="password" id="pass${t}" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button class="btn" data-login="${t}">å…¥å®¤</button>
      </div>
      <div id="area${t}" class="hidden">
        <div class="row" style="justify-content:space-between;align-items:center;margin-top:8px">
          <div class="pill" id="lockBadge${t}">æœªãƒ­ãƒƒã‚¯</div>
          <button class="btn" data-lock="${t}">ãƒ­ãƒƒã‚¯</button>
        </div>
        <table class="table" style="margin-top:6px">
          <thead><tr><th>#</th><th>é¸æ‰‹</th></tr></thead>
          <tbody id="picks${t}"></tbody>
        </table>
      </div>
    </div>`).join('');

  loginGrid.querySelectorAll('button[data-login]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const t = btn.dataset.login;
      const pass = document.getElementById('pass'+t).value;
      socket.emit('leader:login',{pass});
    });
  });
}

function buildTeamPanels(){
  teamsGrid.innerHTML = TEAM_IDS.map(t=>`
    <div class="card">
      <h3>ãƒãƒ¼ãƒ ${t}</h3>
      <div id="team${t}"></div>
    </div>`).join('');
}

function renderLocksBar(){
  locksBar.innerHTML = TEAM_IDS.map(t=>{
    const locked = !!draft.locks?.[t];
    return badge(`${t}:${locked?'LOCK':'OPEN'}`, locked ? 'pill ok' : 'pill lock');
  }).join('');
  TEAM_IDS.forEach(t=>{
    const el = document.getElementById('lockBadge'+t);
    if(el){ el.textContent = draft.locks?.[t] ? 'LOCK' : 'æœªãƒ­ãƒƒã‚¯'; el.className = draft.locks?.[t] ? 'pill ok' : 'pill lock'; }
  });
}

function refreshPickers(){
  for(const t of TEAM_IDS){
    const tbody = document.getElementById('picks'+t); if(!tbody) continue;
    tbody.innerHTML = '';
    const used = new Set(TEAM_IDS.flatMap(x=> draft.teams?.[x] || []));
    for(let i=0;i<MAX_ROUNDS;i++){
      const tr = document.createElement('tr');
      const opts = players.filter(p=>!used.has(p.id));
      tr.innerHTML = `<td class="center">${i+1}</td>
        <td><select data-t="${t}" data-r="${i}" ${ draft.locks?.[t] ? 'disabled':'' }>
        <option value="">ï¼ˆæœªé¸æŠï¼‰</option>
        ${opts.map(p=>`<option value="${p.id}">${escapeHTML(p.name)}ï¼ˆ${p.points}ptï¼‰</option>`).join('')}</select></td>`;
      const sel = tr.querySelector('select');
      sel.value = draft.picks?.[t]?.[i] || '';
      sel.addEventListener('change', ()=> socket.emit('draft:pick', { team:t, round:i, playerId: sel.value }));
      tbody.appendChild(tr);
    }
    const lockBtn = loginGrid.querySelector(`button[data-lock="${t}"]`);
    if(lockBtn){ lockBtn.textContent = draft.locks?.[t] ? 'è§£é™¤' : 'ãƒ­ãƒƒã‚¯';
      lockBtn.onclick = ()=> socket.emit('draft:lock', { team:t, locked: !draft.locks?.[t] });
    }
  }
}

function renderTeams(){
  for(const t of TEAM_IDS){
    const el = document.getElementById('team'+t); if(!el) continue;
    const ids = draft.teams?.[t] || [];
    if(!ids.length){ el.innerHTML = '<div class="note">æœªæ±ºå®š</div>'; continue; }
    const rows = ids.map((id,i)=>{
      const p = players.find(x=>x.id===id); if(!p) return '';
      return `<div class="row" style="margin:6px 0">
        <span class="pill">${i+1}</span>
        <img class="avatar" src="${p.avatar||''}" alt="av" onerror="this.style.display='none'">
        <div><div style="font-weight:600">${escapeHTML(p.name)} <span class="tag">${p.points}pt</span></div>
        <div class="note">${escapeHTML(p.rank)}</div></div></div>`;
    }).join('');
    const total = ids.reduce((s,id)=> s + (players.find(x=>x.id===id)?.points||0), 0);
    el.innerHTML = rows + `<div class="hr"></div><div class="right">åˆè¨ˆãƒã‚¤ãƒ³ãƒˆï¼š<strong>${total}</strong>ï¼ˆ${ids.length}/${MAX_TEAM}ï¼‰</div>`;
  }
}

function updateStateBar(){
  cycleLab.textContent = draft?.state?.cycle ?? '-';
  roundLab.textContent = (draft?.state?.mode==='sequential') ? (String((draft?.state?.round ?? 0)+1)) : '-';
}
function updateNextButton(){
  nextBtn.disabled = (draft?.state?.mode !== 'sequential');
}

function appendLog(line){
  const time=new Date().toLocaleTimeString('ja-JP',{hour12:false});
  logEl.innerHTML += `<div>[${time}] ${line}</div>`;
  logEl.scrollTop = logEl.scrollHeight;
}

document.getElementById('resetDraft').addEventListener('click',()=> socket.emit('draft:reset'));
startDraftBtn.addEventListener('click', ()=> socket.emit('draft:start'));
nextBtn.addEventListener('click', ()=> socket.emit('draft:next'));

function renderAll(){ renderPlayers(); buildLoginCards(); refreshPickers(); buildTeamPanels(); renderTeams(); renderLocksBar(); updateStateBar(); updateNextButton(); }

// ====== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— ======
const exportBtn = document.getElementById('exportBtn');
exportBtn.addEventListener('click', ()=>{
  const actionPass = prompt('æ“ä½œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ›¸ãå‡ºã—ï¼‰'); if(!actionPass) return;
  socket.emit('backup:export', { actionPass });
});
const importFile = document.getElementById('importFile');
importFile.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return; const text = await f.text();
  try{ const data = JSON.parse(text); socket.emit('backup:import', data); alert('èª­ã¿è¾¼ã¿å®Œäº†'); }catch{ alert('JSONãŒä¸æ­£ã§ã™'); }
});
socket.on('backup:data', (data)=>{
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download='unite_draft_backup.json'; a.click(); URL.revokeObjectURL(url);
});
</script>
</body>
</html>
